#!/bin/bash
# RHEL8 AMI EC2 User Data
# set password for fences-user
sed -i 's/^[ \t#]*PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
systemctl reload sshd
update-crypto-policies --set default
echo "HostKeyAlgorithms ssh-ed25519,ecdsa-sha2-nistp256,ecdsa-sha2-nistp384,rsa-sha2-512,rsa-sha2-256,ssh-rsa" >> /etc/ssh/sshd_config


# clean and make dnf cache and install/upgrade all rhel8 packages
dnf clean all && dnf makecache
dnf -y update --nobest
dnf update -y platform-python-pip.noarch --best --allowerasing
dnf install -y dos2unix git vim
dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
dnf -y install docker-ce docker-ce-cli containerd.io docker-compose-plugin
dnf install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm
dnf update
dnf install -y certbot
systemctl enable docker
# selinux disable
sed -i 's/enforcing/disabled/g' /etc/selinux/config
# disable FIPS
fips-mode-setup --disable

# ipv6 off
cat <<EOF >> /etc/sysctl.d/99-local-network.conf
################################################################################
# Local NetworkManager settings and server tuning                              #
################################################################################
#
kernel.randomize_va_space=2
net.ipv4.ip_forward=1
net.ipv4.conf.all.send_redirects=0
net.ipv4.conf.default.send_redirects=0
net.ipv4.conf.default.accept_redirects=0
net.ipv4.conf.all.accept_redirects=0
net.ipv4.conf.default.accept_source_route=0
net.ipv4.icmp_echo_ignore_broadcasts=1
net.ipv4.conf.all.accept_source_route=0
net.ipv6.conf.all.accept_source_route=0
net.ipv6.conf.all.disable_ipv6=1
net.ipv6.conf.default.disable_ipv6=1
EOF

echo "export PATH=$PATH:/usr/local/bin" >> /etc/profile.d/sh.local


## update the open file handles limit for all users
cat <<EOF >> /etc/security/limits.conf
* hard    maxlogins     20
* hard nofile 1000000
* soft nofile 100000
EOF

#create cleanup file
cat <<EOF >> /home/ec2-user/clean.sh
yes | docker system prune --all --volumes
rm -rf logs/ mariadb/ nextcloud/
chown -R ec2-user:ec2-user /home/ec2-user/
EOF
chmod +x /home/ec2-user/clean.sh

# modify docker
cat <<EOF >> /etc/docker/daemon.json
{
  "hosts": ["unix:///var/run/docker.sock", "tcp://0.0.0.0:2375"],
  "debug" : true,
  "default-address-pools" : [{ "base" : "192.168.46.0/16", "size" : 24}]
}
EOF
# disable alias in .bashrc 
sed -i /alias/d $HOME/.bashrc

cp /lib/systemd/system/docker.service /etc/systemd/system/
sed -i 's/\ -H\ fd:\/\///g' /etc/systemd/system/docker.service
systemctl daemon-reload
systemctl restart docker

# prvents the system to inacesible doe to sitig 
touch /var/log/lastlog

systemctl reboot